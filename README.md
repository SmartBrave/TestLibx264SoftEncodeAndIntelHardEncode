### Intel Media SDK与FFmpeg编码性能对比测试


#### 测试要求

开源x264（软编）+ 视骏265（软编）+ h264\_qsv（硬编）+ hevc\_qsv（硬编）

#### 测试场景

1. 串行处理测试
2. 并行处理测试

#### 测试对象

100个视频，原平均大小21.3M,平均时长97s。每个视频最多截取10s进行转码，mp4->mp4。转码后平均大小1.25M,平均时长9.7s。

#### 测试环境

* 操作系统：CentOS 7
* CPU：Intel(R) Xeon(R) CPU E3-1585 v5 @ 3.50GHz  8核心
* 内存：64G

#### 测试使用命令
```
libx264:ffmpeg $duration -i $input0 -i $input1 ... -c:v libx264 -maxrate $maxrate -threads $thread -map 0 $output0 -c:v libx264 -maxrate $maxrate -threads $thread -map 1 $output1 ...

视骏:ffmpeg $duration -i $input0 -i $input1 ... -c:v liblenthevc -maxrate $maxrate -threads $thread -map 0 $output0 -c:v liblenthevc -maxrate $maxrate -threads $thread -map 1 $output1 ...

Intel264:ffmpeg $duration -i $input0 -i $input1 ... -c:v h264_qsv -maxrate $maxrate -threads $thread -map 0 $output0 -c:v h264_qsv -maxrate $maxrate -threads $thread -map 1 $output1 ...

Intel265:ffmpeg $duration -i $input0 -i $input1 ... -c:v hevc_qsv -load_plugin hevc_hw -maxrate $maxrate -threads $thread -map 0 $output0 -c:v hevc_qsv -load_plugin hevc_hw -maxrate -threads $thread -map 1 $output1 ...
```

#### 测试结果

<h5>并发数:1</h5>
<table><tr><th colspan=2>指标</th><th colspan=4>libx264</th><th colspan=4>Intel264</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>19.75</td><td>36.09</td><td>56.5</td><td>87.69</td><td>37.09</td><td>38.12</td><td>36.73</td><td>39.22</td></tr><tr><th>min(%)</th><td>12.62</td><td>19.02</td><td>25.91</td><td>43.36</td><td>15.64</td><td>16.12</td><td>16.46</td><td>15.79</td></tr><tr><th>ave(%)</th><td>13.8035</td><td>25.7951</td><td>41.3567</td><td>64.7331</td><td>21.1231</td><td>21.1263</td><td>21.2489</td><td>21.1724</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>5.36</td><td>5.45</td><td>5.54</td><td>5.06</td><td>4.58</td><td>4.58</td><td>4.58</td><td>4.58</td></tr><tr><th>min(%)</th><td>4.51</td><td>4.52</td><td>4.54</td><td>3.94</td><td>3.97</td><td>3.97</td><td>3.97</td><td>3.97</td></tr><tr><th>ave(%)</th><td>4.85847</td><td>4.88447</td><td>4.90009</td><td>4.34206</td><td>4.19549</td><td>4.19577</td><td>4.19944</td><td>4.18958</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>532.86</td><td>314.78</td><td>229.308</td><td>176.655</td><td>65.284</td><td>65.36</td><td>65.391</td><td>65.46</td></tr><tr><th>user(s)</th><td>576.593</td><td>649.777</td><td>764.683</td><td>923.683</td><td>101.041</td><td>101.21</td><td>101.33</td><td>101.019</td></tr><tr><th>sys(s)</th><td>3.216</td><td>4.786</td><td>6.269</td><td>6.784</td><td>9.756</td><td>9.704</td><td>9.821</td><td>9.703</td></table>
<table><tr><th colspan=2>指标</th><th colspan=4>视骏265</th><th colspan=4>Intel265</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>18.25</td><td>34.09</td><td>61.86</td><td>100</td><td>18.57</td><td>18.4</td><td>19.88</td><td>19.57</td></tr><tr><th>min(%)</th><td>12.62</td><td>22.9</td><td>38.38</td><td>45.35</td><td>9.76</td><td>10.26</td><td>10.4</td><td>10.53</td></tr><tr><th>ave(%)</th><td>14.0105</td><td>27.4176</td><td>52.1053</td><td>87.9499</td><td>14.2858</td><td>14.4375</td><td>14.6623</td><td>14.6744</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>6.89</td><td>6.87</td><td>6.86</td><td>6.87</td><td>5.10</td><td>5.10</td><td>5.10</td><td>5.11</td></tr><tr><th>min(%)</th><td>3.92</td><td>3.92</td><td>3.93</td><td>3.92</td><td>4.50</td><td>4.50</td><td>4.52</td><td>4.51</td></tr><tr><th>ave(%)</th><td>5.26105</td><td>5.24042</td><td>5.21388</td><td>5.20078</td><td>4.75226</td><td>4.75211</td><td>4.7585</td><td>4.76496</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>2595.99</td><td>1329.43</td><td>776.17</td><td>635.173</td><td>126.397</td><td>126.589</td><td>126.523</td><td>126.429</td></tr><tr><th>user(s)</th><td>2854.67</td><td>2883.92</td><td>3215.25</td><td>4455.12</td><td>127.873</td><td>129.089</td><td>130.472</td><td>130.437</td></tr><tr><th>sys(s)</th><td>19.207</td><td>19.333</td><td>21.238</td><td>26.297</td><td>10.051</td><td>10.202</td><td>10.537</td><td>10.436</td></tr></table>
<h5>并发数:4</h5>
<table><tr><th colspan=2>指标</th><th colspan=4>libx264</th><th colspan=4>Intel264</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>21</td><td>61.83</td><td>96.74</td><td>99.87</td><td>44.74</td><td>40.95</td><td>42.86</td><td>42.05</td></tr><tr><th>min(%)</th><td>12.39</td><td>18.88</td><td>21.03</td><td>25.78</td><td>14.38</td><td>13.93</td><td>14.11</td><td>14.65</td></tr><tr><th>ave(%)</th><td>13.6534</td><td>41.713</td><td>64.9638</td><td>79.3612</td><td>23.9197</td><td>24.0129</td><td>24.1395</td><td>24.1071</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>6.30</td><td>6.49</td><td>6.69</td><td>7.05</td><td>6.13</td><td>6.12</td><td>6.12</td><td>6.15</td></tr><tr><th>min(%)</th><td>4.47</td><td>4.47</td><td>4.47</td><td>4.46</td><td>4.76</td><td>4.79</td><td>4.76</td><td>4.76</td></tr><tr><th>ave(%)</th><td>5.46572</td><td>5.51793</td><td>5.59842</td><td>5.73196</td><td>5.47492</td><td>5.47349</td><td>5.48048</td><td>5.4846</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>516.92</td><td>225.639</td><td>169.643</td><td>150.773</td><td>61.701</td><td>61.758</td><td>61.767</td><td>61.771</td></tr><tr><th>user(s)</th><td>562.064</td><td>755.088</td><td>885.176</td><td>964.179</td><td>108.497</td><td>109.096</td><td>109.733</td><td>109.575</td></tr><tr><th>sys(s)</th><td>3.284</td><td>4.525</td><td>5.449</td><td>6.128</td><td>9.88</td><td>10.01</td><td>9.882</td><td>10.02</td></table>
<table><tr><th colspan=2>指标</th><th colspan=4>视骏265</th><th colspan=4>Intel265</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>57.07</td><td>98.88</td><td>100</td><td>100</td><td>22.1</td><td>22.74</td><td>21.93</td><td>32.33</td></tr><tr><th>min(%)</th><td>12.39</td><td>20.03</td><td>27.69</td><td>35.54</td><td>11.4</td><td>11.15</td><td>11.21</td><td>11.18</td></tr><tr><th>ave(%)</th><td>29.8359</td><td>58.8801</td><td>85.2792</td><td>95.0699</td><td>17.102</td><td>16.817</td><td>16.8146</td><td>17.0397</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>12.47</td><td>12.47</td><td>12.43</td><td>12.44</td><td>6.15</td><td>6.15</td><td>6.16</td><td>6.16</td></tr><tr><th>min(%)</th><td>4.66</td><td>4.64</td><td>4.64</td><td>4.65</td><td>4.91</td><td>4.92</td><td>4.88</td><td>4.90</td></tr><tr><th>ave(%)</th><td>9.38546</td><td>9.32705</td><td>9.308</td><td>9.25803</td><td>5.58351</td><td>5.59018</td><td>5.59254</td><td>5.60018</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>1270.27</td><td>785.674</td><td>617.258</td><td>588.118</td><td>112.412</td><td>112.528</td><td>112.462</td><td>112.605</td></tr><tr><th>user(s)</th><td>3019.98</td><td>3685.74</td><td>4197.15</td><td>4455.42</td><td>140.303</td><td>137.745</td><td>137.097</td><td>139.212</td></tr><tr><th>sys(s)</th><td>18.83</td><td>20.461</td><td>22.425</td><td>27.52</td><td>10.25</td><td>10.095</td><td>10.281</td><td>10.299</td></tr></table>
<h5>并发数:8</h5>
<table><tr><th colspan=2>指标</th><th colspan=4>libx264</th><th colspan=4>Intel264</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>24</td><td>84.88</td><td>99.63</td><td>100</td><td>47.74</td><td>48.93</td><td>51.07</td><td>47.86</td></tr><tr><th>min(%)</th><td>12.39</td><td>18.22</td><td>19.83</td><td>24.31</td><td>10.44</td><td>10.34</td><td>12.58</td><td>10.11</td></tr><tr><th>ave(%)</th><td>13.6577</td><td>52.3072</td><td>71.1491</td><td>81.1273</td><td>25.8402</td><td>26.3577</td><td>26.4052</td><td>26.1206</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>7.62</td><td>7.96</td><td>8.26</td><td>8.90</td><td>7.03</td><td>7.03</td><td>7.02</td><td>7.04</td></tr><tr><th>min(%)</th><td>4.54</td><td>4.47</td><td>4.48</td><td>4.55</td><td>4.75</td><td>4.77</td><td>4.73</td><td>4.75</td></tr><tr><th>ave(%)</th><td>6.32571</td><td>6.45254</td><td>6.57962</td><td>6.90082</td><td>5.96048</td><td>5.96984</td><td>5.96468</td><td>5.98032</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>506.88</td><td>191.981</td><td>156.075</td><td>144.584</td><td>60.169</td><td>60.229</td><td>60.194</td><td>60.246</td></tr><tr><th>user(s)</th><td>551.27</td><td>805.296</td><td>894.123</td><td>943.838</td><td>112.316</td><td>114.616</td><td>114.76</td><td>113.815</td></tr><tr><th>sys(s)</th><td>3.164</td><td>4.056</td><td>4.986</td><td>5.454</td><td>11.026</td><td>11.087</td><td>11.169</td><td>10.941</td></table>
<table><tr><th colspan=2>指标</th><th colspan=4>视骏265</th><th colspan=4>Intel265</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>99.12</td><td>100</td><td>100</td><td>100</td><td>35.43</td><td>35.09</td><td>35.18</td><td>33.79</td></tr><tr><th>min(%)</th><td>12.41</td><td>15.21</td><td>16.77</td><td>17.29</td><td>9.18</td><td>9.7</td><td>9.72</td><td>10.18</td></tr><tr><th>ave(%)</th><td>45.8168</td><td>73.2313</td><td>88.7773</td><td>95.1785</td><td>17.9891</td><td>18.3377</td><td>18.3196</td><td>17.9916</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>18.93</td><td>18.90</td><td>18.91</td><td>18.87</td><td>7.06</td><td>7.06</td><td>7.05</td><td>7.07</td></tr><tr><th>min(%)</th><td>4.65</td><td>4.65</td><td>4.65</td><td>4.72</td><td>4.78</td><td>4.77</td><td>4.78</td><td>4.77</td></tr><tr><th>ave(%)</th><td>13.7838</td><td>13.7572</td><td>13.725</td><td>13.73</td><td>6.19072</td><td>6.18396</td><td>6.19775</td><td>6.21</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>964.193</td><td>683.472</td><td>589.268</td><td>571.57</td><td>109.618</td><td>109.716</td><td>109.671</td><td>109.783</td></tr><tr><th>user(s)</th><td>3519.14</td><td>3989.84</td><td>4170.06</td><td>4329.43</td><td>146.024</td><td>148.975</td><td>148.102</td><td>145.55</td></tr><tr><th>sys(s)</th><td>18.894</td><td>20.123</td><td>22.837</td><td>30.366</td><td>10.596</td><td>10.823</td><td>10.899</td><td>10.696</td></tr></table>
<h5>并发数:16</h5>
<table><tr><th colspan=2>指标</th><th colspan=4>libx264</th><th colspan=4>Intel264</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>24.28</td><td>97.12</td><td>100</td><td>100</td><td>50.63</td><td>48.11</td><td>48.37</td><td>49.87</td></tr><tr><th>min(%)</th><td>12.39</td><td>16.52</td><td>15.61</td><td>22.97</td><td>6.58</td><td>7.34</td><td>7</td><td>7.38</td></tr><tr><th>ave(%)</th><td>13.6629</td><td>60.8197</td><td>73.4904</td><td>81.8493</td><td>27.1211</td><td>26.7611</td><td>27.7481</td><td>27.3367</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>9.65</td><td>10.22</td><td>10.77</td><td>11.83</td><td>8.60</td><td>8.61</td><td>8.62</td><td>8.63</td></tr><tr><th>min(%)</th><td>4.47</td><td>4.59</td><td>4.48</td><td>4.50</td><td>4.69</td><td>4.69</td><td>4.70</td><td>4.69</td></tr><tr><th>ave(%)</th><td>8.01303</td><td>8.22608</td><td>8.51729</td><td>9.15741</td><td>7.11281</td><td>7.17754</td><td>7.18509</td><td>7.19684</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>473.654</td><td>165.015</td><td>143.234</td><td>134.134</td><td>55.762</td><td>55.948</td><td>56.026</td><td>56.026</td></tr><tr><th>user(s)</th><td>515.482</td><td>804.475</td><td>844.781</td><td>882.429</td><td>112.218</td><td>110.421</td><td>114.802</td><td>112.939</td></tr><tr><th>sys(s)</th><td>2.877</td><td>3.75</td><td>4.31</td><td>4.994</td><td>10.334</td><td>10.46</td><td>10.701</td><td>10.551</td></table>
<table><tr><th colspan=2>指标</th><th colspan=4>视骏265</th><th colspan=4>Intel265</th></tr><tr><th colspan=2>threads</th><th>1</th><th>2</th><th>4</th><th>8</th><th>1</th><th>2</th><th>4</th><th>8</th></tr><tr><th rowspan=4>CPU</th></tr><tr><th>max(%)</th><td>100</td><td>100</td><td>100</td><td>100</td><td>37.94</td><td>38.99</td><td>39.67</td><td>38.13</td></tr><tr><th>min(%)</th><td>12.5</td><td>13.16</td><td>13.38</td><td>13.38</td><td>6.99</td><td>6.98</td><td>6.87</td><td>7.38</td></tr><tr><th>ave(%)</th><td>59.8225</td><td>78.6981</td><td>90.5222</td><td>94.9601</td><td>19.5669</td><td>19.85</td><td>19.5474</td><td>19.4269</td></tr><tr><th rowspan=4>MEM</th></tr><tr><th>max(%)</th><td>29.62</td><td>29.62</td><td>29.59</td><td>29.57</td><td>8.74</td><td>8.74</td><td>8.74</td><td>8.76</td></tr><tr><th>min(%)</th><td>4.68</td><td>4.65</td><td>4.70</td><td>4.66</td><td>4.76</td><td>4.80</td><td>4.79</td><td>4.80</td></tr><tr><th>ave(%)</th><td>22.4678</td><td>22.5912</td><td>22.6115</td><td>22.5606</td><td>7.59962</td><td>7.60529</td><td>7.62433</td><td>7.62115</td></tr><tr><th rowspan=4>TIME</th></tr><tr><th>real(s)</th><td>792.586</td><td>622.428</td><td>552.074</td><td>538.76</td><td>103.012</td><td>102.968</td><td>103.014</td><td>103.086</td></tr><tr><th>user(s)</th><td>3780.84</td><td>3906.81</td><td>3979.18</td><td>4069.4</td><td>149.264</td><td>151.247</td><td>148.894</td><td>147.673</td></tr><tr><th>sys(s)</th><td>17.503</td><td>18.553</td><td>24.101</td><td>30.784</td><td>11.372</td><td>11.573</td><td>11.4</td><td>11.466</td></tr></table>

#### 结论

1. 可以看出，随着线程数的增加，软编（包括264和265）的CPU使用率越来越高，编码时间也越来越短；由于CPU是8核心，所以在线程为8时耗时最短（暂没有测试thread大于8的情况）；
2. 随着任务数增加，软编的CPU占用率有所增加，耗时有所减少；
3. 由于硬编使用GPU进行转码，所以CPU使用率和转码时间基本不受任务数和线程数的影响，比较恒定；
4. 不管是硬编还是软编，内存使用率基本稳定且一致；
